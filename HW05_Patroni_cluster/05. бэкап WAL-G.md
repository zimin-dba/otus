```
 Host  |       IP         |     VIP		 |        Role
 ------|------------------|-------------------------------------------
 HA1   |	192.168.1.71  |	192.168.1.70 |  HAproxy+keepalived
 HA2   |	192.168.1.72  |	192.168.1.70 |  HAproxy+keepalived
 PG1   |	192.168.1.81  |	    		 |  leader/synchronius replica
 PG2   |	192.168.1.82  |	    		 |  leader/synchronius replica
 PG3   |	192.168.1.83  |	    		 |	asynchronius replica
 ETCD1 |	192.168.1.91  |				 |
 ETCD2 |	192.168.1.92  |				 |
 ETCD3 |	192.168.1.93  |				 |
```

### Настройка бэкапов WAL-G на асинхронной реплике - PG3

#### Скачиваю и муваю 
`wget https://github.com/wal-g/wal-g/releases/download/v3.0.7/wal-g-pg-ubuntu-24.04-amd64 -O wal-g && sudo mv wal-g /usr/local/bin/wal-g`

`sudo chmod +x /usr/local/bin/wal-g
sudo chown postgres:postgres /usr/local/bin/wal-g`

#### Создаю каталоги
`sudo su postgres
mkdir -p /var/lib/postgresql/backups/{wal,base}
mkdir -p /var/lib/postgresql/backups/logs`

#### Конфиг WAL-G

```
cat > /var/lib/postgresql/config.json << 'EOF'
{
    "WALG_FILE_PREFIX": "/var/lib/postgresql/backups/",
    "WALG_COMPRESSION_METHOD": "lz4",
    "PGDATA": "/var/lib/postgresql/18/main",
    "WALG_LOG_LEVEL": "DEVEL",
    "S3_LOG_LEVEL": "DEVEL"
}
EOF
```

#### Скрипт бэкапа

```
cat > /var/lib/postgresql/backup-script.sh << 'EOF'
#!/bin/bash
log_file="/var/lib/postgresql/backups/logs/backup-$(date +%Y%m%d-%H%M%S).log"
bdpath="/var/lib/postgresql/18/main"
cfg="/var/lib/postgresql/config.json"
{
    echo "=== Starting backup at $(date) ==="
    echo "Creating backup ..."
    wal-g backup-push $bdpath --config=$cfg
    echo "=== Backup completed at $(date) ==="
} >> $log_file 2>&1
EOF
```

#### Добавляю настройки в postgresql.auto.conf, так как настройки в postgresql.conf могут быть переопределены кластером Patroni
`cat >> /var/lib/postgresql/18/main/postgresql.auto.conf << 'EOF'`

`psql -c "ALTER SYSTEM SET archive_mode = 'on';"
psql -c "ALTER SYSTEM SET wal_level = 'replica';"
psql -c "ALTER SYSTEM SET max_wal_senders = '10';"
psql -c "ALTER SYSTEM SET wal_keep_size = '1024MB';"`

#### На лидере кластера Patroni:

`sudo su postgres`

`select pg_reload_conf();`

#### Проверка - бэкап одного WAL-файла

`/usr/local/bin/wal-g wal-push /var/lib/postgresql/18/main/pg_wal/000000030000000000000003 --config=/var/lib/postgresql/config.json`

#### Работает:

```
DEBUG: 2025/11/02 16:55:07.387803 --- COMPILED ENVIRONMENT VARS ---
INFO: 2025/11/02 16:55:07.393920 Files will be uploaded to storage: default
DEBUG: 2025/11/02 16:55:07.397719 Put 000000030000000000000003.lz4 into wal_005
INFO: 2025/11/02 16:55:07.573768 FILE PATH: 000000030000000000000003.lz4
```

#### Скрипт полного бэкапа

```
sudo su postgres
cat > /var/lib/postgresql/backup-script.sh << 'EOF'
#!/bin/bash
log_file="/var/lib/postgresql/backups/logs/backup-$(date +%Y%m%d-%H%M%S).log"
bdpath="/var/lib/postgresql/18/main"
cfg="/var/lib/postgresql/config.json"
{
    echo "=== Starting backup at $(date) ==="
    # Создаем полный бэкап
    echo "Creating backup ..."
    wal-g backup-push $bdpath --config=$cfg
    # Очистка старых бэкапов (храним 7 последних)
    echo "Purging old backups ..."
    wal-g delete --config=$cfg retain 7 --confirm
    echo "=== Backup completed at $(date) ==="
} >> $log_file 2>&1
```

    # Создаем полный бэкап
​    echo "Creating backup ..."
​    wal-g backup-push $bdpath --config=$cfg
​    # Очистка старых бэкапов (храним 7 последних)
​    echo "Purging old backups ..."
​    wal-g delete --config=$cfg retain 7 --confirm
​    echo "=== Backup completed at $(date) ==="
} >> $log_file 2>&1

`chmod +x /var/lib/postgresql/backup-script.sh`

#### Лог полного бэкапа

```
=== Starting backup at Sat Nov  8 20:34:37 +05 2025 ===
Creating backup ...
INFO: 2025/11/08 20:34:37.859755 Backup will be pushed to storage: default
INFO: 2025/11/08 20:34:37.914737 Calling pg_start_backup()
INFO: 2025/11/08 20:34:37.917137 Initializing the PG alive checker (interval=1m0s)...
INFO: 2025/11/08 20:34:37.917220 Starting a new tar bundle
INFO: 2025/11/08 20:34:37.917247 Walking ...
INFO: 2025/11/08 20:34:37.917528 Starting part 1 ...
INFO: 2025/11/08 20:34:38.682987 Packing ...
INFO: 2025/11/08 20:34:38.700817 Finished writing part 1.
INFO: 2025/11/08 20:34:38.718801 Starting part 2 ...
INFO: 2025/11/08 20:34:38.719151 /global/pg_control
INFO: 2025/11/08 20:34:38.719460 Finished writing part 2.
INFO: 2025/11/08 20:34:38.719468 Calling pg_stop_backup()
INFO: 2025/11/08 20:34:38.721046 Starting part 3 ...
INFO: 2025/11/08 20:34:38.721240 backup_label
INFO: 2025/11/08 20:34:38.721259 tablespace_map
INFO: 2025/11/08 20:34:38.721858 Finished writing part 3.
INFO: 2025/11/08 20:34:38.724038 Querying pg_database
INFO: 2025/11/08 20:34:38.941339 Wrote backup with name base_0000000B0000000000000005 to storage default
=== Backup completed at Sat Nov  8 20:34:38 +05 2025 ===
```



