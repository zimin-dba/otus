```
 Host  |       IP         |     VIP		 |        Role
 ------|------------------|-------------------------------------------
 HA1   |	192.168.1.71  |	192.168.1.70 |  HAproxy+keepalived
 HA2   |	192.168.1.72  |	192.168.1.70 |  HAproxy+keepalived
 PG1   |	192.168.1.81  |	    		 |  leader/synchronius replica
 PG2   |	192.168.1.82  |	    		 |  leader/synchronius replica
 PG3   |	192.168.1.83  |	    		 |	asynchronius replica
 ETCD1 |	192.168.1.91  |				 |
 ETCD2 |	192.168.1.92  |				 |
 ETCD3 |	192.168.1.93  |				 |
```

# Установка и конфигурирование ETCD

Руководствуюсь оф. докой: https://etcd.io/docs/v3.6/install/

wget https://github.com/etcd-io/etcd/releases/download/v3.6.0/etcd-v3.6.0-linux-amd64.tar.gz


`tar xvf etcd-v${ETCD_VERSION}-linux-amd64.tar.gz
sudo cp etcd-v${ETCD_VERSION}-linux-amd64/etcd /usr/local/bin/
sudo cp etcd-v${ETCD_VERSION}-linux-amd64/etcdctl /usr/local/bin/`

Проверка:

`etcd --version
etcd Version: 3.6.0
Git SHA: f5d605a
Go Version: go1.23.9
Go OS/Arch: linux/amd64`


### Создание службы etcd:

```console
cat > /etc/systemd/system/etcd.service <<EOF
[Unit]
Description=etcd key-value store
Documentation=https://etcd.io/docs
After=network.target

[Service]
User=otus
Type=notify
EnvironmentFile=-/etc/etcd/etcd.conf
ExecStart=/usr/local/bin/etcd
Restart=always
RestartSec=10s
LimitNOFILE=40000

[Install]
WantedBy=multi-user.target
EOF
```

Подготовка:

`sudo mkdir /etc/etcd/
sudo touch /etc/etcd/etcd.conf
sudo chown -R otus:otus /etc/etcd
sudo chmod 600 /etc/etcd/etcd.conf
sudo mkdir -p /var/lib/etcd
sudo chown otus:otus /var/lib/etcd`

### Создание конфигов etcd на каждой ноде
**ETCD1:**
cat > /etc/etcd/etcd.conf <<EOF
ETCD_NAME="etcd1"
ETCD_DATA_DIR="/var/lib/etcd/pg_cluster"
ETCD_LISTEN_PEER_URLS="http://0.0.0.0:2380"
ETCD_LISTEN_CLIENT_URLS="http://0.0.0.0:2379"
ETCD_INITIAL_ADVERTISE_PEER_URLS="http://192.168.1.91:2380"
ETCD_INITIAL_CLUSTER="etcd1=http://192.168.1.91:2380,etcd2=http://192.168.1.92:2380,etcd3=http://192.168.1.93:2380"
ETCD_INITIAL_CLUSTER_STATE="new"
ETCD_INITIAL_CLUSTER_TOKEN="pg_cluster"
ETCD_ADVERTISE_CLIENT_URLS="http://192.168.1.91:2379"
ETCD_ELECTION_TIMEOUT="10000"
ETCD_HEARTBEAT_INTERVAL="2000"
EOF

**ETCD2:**
cat > /etc/etcd/etcd.conf <<EOF
ETCD_NAME="etcd2"
ETCD_DATA_DIR="/var/lib/etcd/pg_cluster"
ETCD_LISTEN_PEER_URLS="http://0.0.0.0:2380"
ETCD_LISTEN_CLIENT_URLS="http://0.0.0.0:2379"
ETCD_INITIAL_ADVERTISE_PEER_URLS="http://192.168.1.92:2380"
ETCD_INITIAL_CLUSTER="etcd1=http://192.168.1.91:2380,etcd2=http://192.168.1.92:2380,etcd3=http://192.168.1.93:2380"
ETCD_INITIAL_CLUSTER_STATE="new"
ETCD_INITIAL_CLUSTER_TOKEN="pg_cluster"
ETCD_ADVERTISE_CLIENT_URLS="http://192.168.1.92:2379"
ETCD_ELECTION_TIMEOUT="10000"
ETCD_HEARTBEAT_INTERVAL="2000"
EOF

**ETCD3:**
cat > /etc/etcd/etcd.conf <<EOF
ETCD_NAME="etcd3"
ETCD_DATA_DIR="/var/lib/etcd/pg_cluster"
ETCD_LISTEN_PEER_URLS="http://0.0.0.0:2380"
ETCD_LISTEN_CLIENT_URLS="http://0.0.0.0:2379"
ETCD_INITIAL_ADVERTISE_PEER_URLS="http://192.168.1.93:2380"
ETCD_INITIAL_CLUSTER="etcd1=http://192.168.1.91:2380,etcd2=http://192.168.1.92:2380,etcd3=http://192.168.1.93:2380"
ETCD_INITIAL_CLUSTER_STATE="new"
ETCD_INITIAL_CLUSTER_TOKEN="pg_cluster"
ETCD_ADVERTISE_CLIENT_URLS="http://192.168.1.93:2379"
ETCD_ELECTION_TIMEOUT="10000"
ETCD_HEARTBEAT_INTERVAL="2000"
EOF

`sudo systemctl start etcd
sudo systemctl status etcd
sudo systemctl enable etcd`

## Проверки:

### Ноды кластера

`ETCDCTL_API=3 sudo etcdctl --endpoints=192.168.1.91:2379,192.168.1.92:2379,192.168.1.93:2379 member list`
4b0060fc630e9023, started, etcd1, http://192.168.1.91:2380, http://192.168.1.91:2379, false
d308cc899707c068, started, etcd3, http://192.168.1.93:2380, http://192.168.1.93:2379, false
d816365a4004abfa, started, etcd2, http://192.168.1.92:2380, http://192.168.1.92:2379, false

### Здоровье кластера

`ETCDCTL_API=3 sudo etcdctl --endpoints=192.168.1.91:2379,192.168.1.92:2379,192.168.1.93:2379 endpoint health`
192.168.1.93:2379 is healthy: successfully committed proposal: took = 29.965592ms
192.168.1.92:2379 is healthy: successfully committed proposal: took = 38.092159ms
192.168.1.91:2379 is healthy: successfully committed proposal: took = 38.111544ms

### Вывод лидера
`etcdctl member list -w fields|awk -v l=$(etcdctl endpoint status -w fields|awk '/"Leader"/{print $3}') '$0~l{getline;print $3}'`

"etcd1"

### Логи ETCD
`sudo journalctl -u etcd -f -n 30`



