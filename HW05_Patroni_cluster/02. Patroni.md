```
 Host  |       IP         |     VIP		 |        Role
 ------|------------------|-------------------------------------------
 HA1   |	192.168.1.71  |	192.168.1.70 |  HAproxy+keepalived
 HA2   |	192.168.1.72  |	192.168.1.70 |  HAproxy+keepalived
 PG1   |	192.168.1.81  |	    		 |  leader/synchronius replica
 PG2   |	192.168.1.82  |	    		 |  leader/synchronius replica
 PG3   |	192.168.1.83  |	    		 |	asynchronius replica
 ETCD1 |	192.168.1.91  |				 |
 ETCD2 |	192.168.1.92  |				 |
 ETCD3 |	192.168.1.93  |				 |
```

### Создание кластера Patroni

#### Установка PostgreSQL 18 

`sudo apt update && sudo apt upgrade -y && sudo sh -c 'echo "deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list' && wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add - && sudo apt-get update && sudo apt-get -y install postgresql`

#### Устанавливаю последнюю доступную версию Patroni из репозитория PGDG, вместе с пакетом, который является Python клиентом для etcd - необходим Patroni для взаимодействия с кластером etcd

`sudo apt install -y curl gnupg
curl -fsSL https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo gpg --dearmor -o /usr/share/keyrings/postgresql-archive-keyring.gpg
echo "deb [signed-by=/usr/share/keyrings/postgresql-archive-keyring.gpg] http://apt.postgresql.org/pub/repos/apt noble-pgdg main" | sudo tee /etc/apt/sources.list.d/pgdg.list`

`sudo apt install -y patroni python3-etcd`

#### версии Patroni и python3-etcd:
`patroni --version && dpkg -s python3-etcd | grep Version`
patroni 4.1.0
Version: 0.4.5-4

#### Останавливаю и удаляю экземлпяр постгреса, который запускается по умолчанию:

`sudo systemctl status postgresql@18-main
sudo systemctl stop postgresql@18-main
sudo -u postgres pg_dropcluster 18 main 
sudo systemctl daemon-reload`

#### Проверка отсутствия экземпляра postgresql:

`pg_lsclusters`
Ver Cluster Port Status Owner Data directory Log file

Конфиг для каждой ноды кластера Patroni - свой.
В конфигах PG2 и PG3 отсутствует секция bootstrap, так как они получат конфигурацию из DCS (etcd).

#### Конфиг для pg1

```
cat > /etc/patroni/patroni.yml <<EOF
scope: postgres-cluster
name: pg1

restapi:
  listen: 192.168.1.81:8008
  connect_address: 192.168.1.81:8008

etcd3:
  hosts: 192.168.1.91:2379,192.168.1.92:2379,192.168.1.93:2379
  protocol: http

bootstrap:
  dcs:
    ttl: 30
    loop_wait: 10
    retry_timeout: 10
    maximum_lag_on_failover: 1048576
    postgresql:
      use_pg_rewind: true
      parameters:
  initdb:
  - encoding: UTF8
  - data-checksums

  pg_hba:

  - host replication replicator 192.168.1.0/24 md5
  - host all rewind_user 192.168.1.0/24 md5
  - host all all 127.0.0.1/32  trust
  - local all all              trust

  post_bootstrap: |
    psql -c "CREATE USER replicator WITH REPLICATION PASSWORD '123';"

postgresql:
  listen: 127.0.0.1, 192.168.1.81:5432
  connect_address: 192.168.1.81:5432
  data_dir: /var/lib/postgresql/18/main
  bin_dir: /usr/lib/postgresql/18/bin
  pgpass: /var/lib/postgresql/pgpass0
  authentication:
    replication:
      username: replicator
      password: "123"
    superuser:
      username: postgres
      password: "123"
    rewind:
      username: rewind_user
      password: "123"
  parameters:
    synchronous_commit: 'on'
    synchronous_standby_names: 'ANY 1 (pg1,pg2)'
    log_destination: stderr
    logging_collector: on
    log_directory: /var/log/postgresql
    log_filename: postgresql-18-main.log
    log_rotation_age: 1d
    log_rotation_size: 100MB

tags:
    nofailover: false
    noloadbalance: false
    clonefrom: true
    nosync: false
EOF
```

#### Конфиг для pg2

```
cat > /etc/patroni/patroni.yml <<EOF
scope: postgres-cluster
name: pg2

restapi:
  listen: 192.168.1.82:8008
  connect_address: 192.168.1.82:8008

etcd3:
  hosts: 192.168.1.91:2379,192.168.1.92:2379,192.168.1.93:2379
  protocol: http

postgresql:
  listen: 127.0.0.1, 192.168.1.82:5432
  connect_address: 192.168.1.82:5432
  data_dir: /var/lib/postgresql/18/main
  bin_dir: /usr/lib/postgresql/18/bin
  pgpass: /var/lib/postgresql/pgpass0
  authentication:
    replication:
      username: replicator
      password: "123"
    superuser:
      username: postgres
      password: "123"
    rewind:
      username: rewind_user
      password: "123"
  parameters:
    synchronous_commit: 'on'
    synchronous_standby_names: 'ANY 1 (pg1,pg2)'
    log_destination: stderr
    logging_collector: on
    log_directory: /var/log/postgresql
    log_filename: postgresql-18-main.log
    log_rotation_age: 1d
    log_rotation_size: 100MB

tags:
    nofailover: false
    noloadbalance: false
    clonefrom: true
    nosync: false
EOF
```

####  Конфиг для pg3

```
cat > /etc/patroni/patroni.yml <<EOF
scope: postgres-cluster
name: pg3

restapi:
  listen: 192.168.1.83:8008
  connect_address: 192.168.1.83:8008

etcd3:
  hosts: 192.168.1.91:2379,192.168.1.92:2379,192.168.1.93:2379
  protocol: http

postgresql:
  listen: 127.0.0.1, 192.168.1.83:5432
  connect_address: 192.168.1.83:5432
  data_dir: /var/lib/postgresql/18/main
  bin_dir: /usr/lib/postgresql/18/bin
  pgpass: /var/lib/postgresql/pgpass0
  authentication:
    replication:
      username: replicator
      password: "123"
    superuser:
      username: postgres
      password: "123"
    rewind:
      username: rewind_user
      password: "123"
  parameters:
    synchronous_commit: 'off'
    synchronous_standby_names: ''
    log_destination: stderr
    logging_collector: on
    log_directory: /var/log/postgresql
    log_filename: postgresql-18-main.log
    log_rotation_age: 1d
    log_rotation_size: 100MB

tags:
    nofailover: true
    noloadbalance: true
    clonefrom: false
    nosync: true
EOF
```



#### На всех трёх нодах настраиваю службу, которая будет стартовать patroni

Существующий конфиг службы будет перезаписан.
Где находится конфиг службы:
`systemctl show patroni.service -p FragmentPath
sudo systemctl stop patroni.service`
FragmentPath=/usr/lib/systemd/system/patroni.service

```
cat > /usr/lib/systemd/system/patroni.service <<EOF
[Unit]
Description=High availability PostgreSQL Cluster
After=syslog.target network.target

[Service]
Type=simple
User=postgres
Group=postgres
ExecStart=/usr/bin/patroni /etc/patroni/patroni.yml
KillMode=process
TimeoutSec=30
Restart=no

[Install]
WantedBy=multi-user.target
EOF
После изменения конфига службы нужно перезагрузить конфигурацию systemd:
sudo systemctl daemon-reload
```

#### На PG1:

Первый запуск делал вручную, затем - стартом сервиса.

`patroni /etc/patroni/patroni.yml`

`sudo systemctl start patroni
sudo systemctl status patroni`

```
Nov 01 15:53:30 pg1 patroni[1566]: server promoting
Nov 01 15:53:30 pg1 patroni[1530]: 2025-11-01 15:53:30,456 INFO: Lock owner: pg1; I am pg1
Nov 01 15:53:30 pg1 patroni[1530]: 2025-11-01 15:53:30,616 INFO: updated leader lock during promote
Nov 01 15:53:31 pg1 patroni[1530]: 2025-11-01 15:53:31,637 INFO: no action. I am (pg1), the leader with the lock
```

#### На PG2:

`sudo systemctl start patroni
sudo systemctl status patroni`

```
Nov 01 15:56:44 pg2 patroni[1418]: 2025-11-01 15:56:44,745 INFO: Lock owner: pg1; I am pg2
Nov 01 15:56:44 pg2 patroni[1418]: 2025-11-01 15:56:44,745 INFO: establishing a new patroni heartbeat connection to postgres
Nov 01 15:56:44 pg2 patroni[1418]: 2025-11-01 15:56:44,922 INFO: no action. I am (pg2), a secondary, and following a leader (pg1)
```

#### И, наконец, на PG3:

`sudo systemctl start patroni
sudo systemctl status patroni`

```
Nov 01 15:58:44 pg3 patroni[78169]: localhost:5432 - accepting connections
Nov 01 15:58:44 pg3 patroni[78139]: 2025-11-01 15:58:44,238 INFO: Lock owner: pg1; I am pg3
Nov 01 15:58:44 pg3 patroni[78139]: 2025-11-01 15:58:44,238 INFO: establishing a new patroni heartbeat connection to postgres
Nov 01 15:58:44 pg3 patroni[78139]: 2025-11-01 15:58:44,386 INFO: no action. I am (pg3), a secondary, and following a leader (pg1)
```

#### С лидера:

`psql -c "SELECT application_name, sync_state, sync_priority FROM pg_stat_replication;"`

```
 application_name | sync_state | sync_priority
-------------------------------------------------
 pg3              | async      |       0
 pg2              | quorum     |       1
```

#### Статус кластера через Patroni
`patronictl -c /etc/patroni/patroni.yml list`

#### История переключений
`sudo patronictl -c /etc/patroni/patroni.yml history`

```
+----+----------+------------------------------+----------------------------------+------
| TL |      LSN | Reason                       | Timestamp                        | New  |	  |																			   |Leader
+----+----------+------------------------------+----------------------------------+------
|  1 | 55008104 | no recovery target specified | 2025-11-02T14:11:18.230469+05:00 | pg2   
|  2 | 59491712 | no recovery target specified | 2025-11-02T14:13:54.024465+05:00 | pg1   
|  3 | 59494992 | no recovery target specified | 2025-11-02T14:52:12.070001+05:00 | pg2   
|  4 | 67250512 | no recovery target specified | 2025-11-02T19:55:38.032319+05:00 | pg1   
|  5 | 83886240 | no recovery target specified | 2025-11-03T15:15:35.174999+05:00 | pg1   
|  6 | 83886888 | no recovery target specified | 2025-11-05T15:48:29.030090+05:00 | pg2   
|  7 | 83887328 | no recovery target specified | 2025-11-06T12:24:18.133738+05:00 | pg2   
+----+----------+------------------------------+----------------------------------+------
```

#### Конфигурация кластера Patroni
`patronictl -c /etc/patroni/patroni.yml show-config`

```
loop_wait: 10
maximum_lag_on_failover: 1048576
postgresql:
  parameters: null
  use_pg_rewind: true
retry_timeout: 10
ttl: 30
```



#### Тип репликации
`psql -U postgres -c "SELECT application_name, client_addr, state, sync_state, replay_lag FROM pg_stat_replication;"`

```
application_name | client_addr  |   state   | sync_state | replay_lag
------------------+--------------+-----------+------------+------------
 pg3              | 192.168.1.83 | streaming | async      |
 pg1              | 192.168.1.81 | streaming | quorum     |
```

#### Отставание реплик от мастера и есть ли оно
`psql -U postgres -c "SELECT
    client_addr,
    application_name,
    pg_current_wal_lsn() AS current_master_lsn, -- LSN на лидере
    replay_lsn AS replica_replay_lsn, -- LSN реплики
    pg_wal_lsn_diff(pg_current_wal_lsn(), replay_lsn) AS replay_lag_bytes -- Разница между ними
FROM pg_stat_replication;"`

```
client_addr  | application_name | current_master_lsn | replica_replay_lsn | replay_lag
--------------+------------------+--------------------+--------------------+-------------
 192.168.1.83 | pg3              | 0/5000620          | 0/5000620          |         0
 192.168.1.81 | pg1              | 0/5000620          | 0/5000620          |         0
```
