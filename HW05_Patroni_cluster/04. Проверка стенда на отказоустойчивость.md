### Проверка всего стенда на отказоустойчивость

```
 Host  |       IP         |     VIP		 |        Role
 ------|------------------|-------------------------------------------
 HA1   |	192.168.1.71  |	192.168.1.70 |  HAproxy+keepalived
 HA2   |	192.168.1.72  |	192.168.1.70 |  HAproxy+keepalived
 PG1   |	192.168.1.81  |	    		 |  leader/synchronius replica
 PG2   |	192.168.1.82  |	    		 |  leader/synchronius replica
 PG3   |	192.168.1.83  |	    		 |	asynchronius replica
 ETCD1 |	192.168.1.91  |				 |
 ETCD2 |	192.168.1.92  |				 |
 ETCD3 |	192.168.1.93  |				 |
```



### 1) Выключение лидера PG1 (192.168.1.81)

#### Текущее состояние:

```
Cluster: postgres-cluster (7568047097531365342) -+-------------+-----+------------+---
| Member | Host         | Role    | State     | TL | Receive LSN | Lag | Replay LSN | Lag | Tags                |
+--------+--------------+---------+-----------+----+-------------+-----+------------+-
| pg1    | 192.168.1.81 | Leader  | running   | 13 |             |     |            |     |     |
+--------+--------------+---------+-----------+----+-------------+-----+------------+-
| pg2    | 192.168.1.82 | Replica | streaming | 13 |   0/59B1120 |   0 |  0/59B1120 |   0 |     |
+--------+--------------+---------+-----------+----+-------------+-----+------------+-
| pg3    | 192.168.1.83 | Replica | streaming | 13 |   0/59B1120 |   0 |  0/59B1120 |   0 |     |
+--------+--------------+---------+-----------+----+-------------+-----+------------+-
```

#### Создаю БД otus на лидере PG1 и подключаюсь к ней:
`otus@pg3:~$ psql -h 192.168.1.70 -p 5432 -U postgres -c "create database otus";`
`psql -h 192.168.1.70 -p 5432 -U postgres -d otus`

#### Создаю таблицу и наполняю данными:
`otus=# create table test7 (n integer, t text);
otus=# insert into test7 (n, t) values (1, 'aa');
otus=# insert into test7 (n, t) values (2, 'bb');
otus=# insert into test7 (n, t) values (3, 'cc');`

#### На лидере кластера Patroni - PG1 - происходит сбой по питанию:
#### (эффект выполнения команды равносилен аварийному выключению)
`VBoxManage controlvm "PG1" poweroff`

#### Проверяю кластер Patroni:

`otus@pg3:~$ patronictl -c /etc/patroni/patroni.yml list`

```
Cluster: postgres-cluster (7568047097531365342) -+-------------+-----+------------+-----
| Member | Host         | Role    | State     | TL | Receive LSN | Lag | Replay LSN | Lag | Tags                |
+--------+--------------+---------+-----------+----+-------------+-----+------------+----
| pg2    | 192.168.1.82 | Leader  | running   | 14 |             |     |            |     |        |
+--------+--------------+---------+-----------+----+-------------+-----+------------+----
| pg3    | 192.168.1.83 | Replica | streaming | 14 |   0/5DF8B00 |   0 |  0/5DF8B00 |   0 |        |
+--------+--------------+---------+-----------+----+-------------+-----+------------+----
```

#### Произошла смена лидера: PG1 -> PG2

#### БД по прежнему доступна:

`otus@pg3:~$ psql -h 192.168.1.70 -p 5432 -U postgres -d otus -c "SELECT * FROM public.test7";`

```
 n | t
---+----
 1 | aa
 2 | bb
 3 | cc
```



### 2) Аварийное выключение ETCD2 (лидер)

#### Определение кто лидер на ETCD
`otus@etcd3:~$ etcdctl member list -w fields|awk -v l=$(etcdctl endpoint status -w fields|awk '/"Leader"/{print $3}') '$0~l{getline;print $3}'`
"etcd2"

#### На лидере ETCD2 происходит сбой по питанию:
`VBoxManage controlvm "ETCD2" poweroff`

#### Определение кто теперь лидер на ETCD
`otus@etcd3:~$ etcdctl member list -w fields|awk -v l=$(etcdctl endpoint status -w fields|awk '/"Leader"/{print $3}') '$0~l{getline;print $3}'`
"etcd1"

#### Произошла смена лидера: ETCD2 -> ETCD1

#### Кластер Patroni работает, данные доступны:
`otus@pg3:~$ psql -h 192.168.1.70 -p 5432 -U postgres -d otus -c "SELECT * FROM public.test7";`

```
 n | t
---+----
 1 | aa
 2 | bb
 3 | cc
```



### 3) Аварийное выключение HA1 (мастер)

#### Определение кто лидер в кластере HAProxy
`otus@ha2:~$ echo "HA1: $(ip addr show | grep -q 192.168.1.70 && echo 'MASTER' || echo 'BACKUP')"`
HA1: MASTER
`otus@ha2:~$ echo "HA2: $(ip addr show | grep -q 192.168.1.70 && echo 'MASTER' || echo 'BACKUP')"`
HA2: BACKUP

#### На мастере HA1 происходит сбой по питанию:
`VBoxManage controlvm "HA1" poweroff`

#### Теперь мастер - HA2:
`otus@ha2:~$ echo "HA2: $(ip addr show | grep -q 192.168.1.70 && echo 'MASTER' || echo 'BACKUP')"`
HA2: MASTER

#### Кластер Patroni работает, данные доступны:
`otus@pg3:~$ psql -h 192.168.1.70 -p 5432 -U postgres -d otus -c "SELECT * FROM public.test7";`

```
 n | t
---+----
 1 | aa
 2 | bb
 3 | cc
```

